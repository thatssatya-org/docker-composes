name: Deploy immich

on:
  push:
    branches:
      - main
    paths:
      - 'immich/immich-server.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Tailscale Connection
        uses: tailscale/github-action@v4
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
          tags: tag:ci
          version: latest
          ping: ${{ vars.IMMICH_SERVER_HOST }}
      - name: Create .env file
        run: echo "${{ secrets.IMMICH_DOT_ENV_SECRETS }}" > .env
      - name: Deploy
        run: |
          # Update repository
          ssh -o "StrictHostKeyChecking=no" ${{ vars.IMMICH_SERVER_USER }}@${{ vars.IMMICH_SERVER_HOST }} "
            if [ ! -d ~/docker-composes ]; then
              git clone https://github.com/${{ github.repository }}.git ~/docker-composes
            else
              cd ~/docker-composes
              git pull
            fi
          "

          # Copy .env file to remote
          scp -o "StrictHostKeyChecking=no" .env ${{ vars.IMMICH_SERVER_USER }}@${{ vars.IMMICH_SERVER_HOST }}:~/docker-composes/immich/.env

          # Start services
          ssh -o "StrictHostKeyChecking=no" ${{ vars.IMMICH_SERVER_USER }}@${{ vars.IMMICH_SERVER_HOST }} "
            cd ~/docker-composes/immich
            docker compose -f immich-server.yml up -d
          "